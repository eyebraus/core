# syntax=docker/dockerfile:labs

# Arrange arguments
ARG target=development
ARG workspaceDir=/workspace

# ================
# stage
# ================
FROM docker.io/node:current-bullseye-slim AS stage
ARG workspaceDir

# Set working directory
WORKDIR ${workspaceDir}

# Install dependencies
COPY package.json package-lock.json ./
RUN npm install --include dev

# Copy other files needed for subsequent targets
COPY eslint.config.ts tsconfig.json ./
COPY --from=projects --parents foo ./packages/

# ================
# build
# ================
FROM stage AS build

# Build!
WORKDIR ${workspaceDir}/packages/foo
RUN npx tsc --build

ENTRYPOINT [ "/bin/sh", "-c" ]

# ================
# test
# ================
FROM build AS test

# Test!
WORKDIR ${workspaceDir}/packages/foo
RUN npx jest --coverage; exit 0

ENTRYPOINT [ "/bin/sh", "-c" ]
